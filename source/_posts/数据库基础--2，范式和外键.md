---
title: 数据库基础--2，范式和外键
date: 2017-10-17 13:48:54
toc: true
comment: true
tags:
 - 数据库
---


之前的数据库学的不怎么扎实，现在想把数据库的基础都过一下。

## 关系型数据库的范式

我是看了知乎上面一位老师对于范式的解答，非常通俗易懂： [解释一下关系型数据库的第一第二第三范式][1]


### 第一范式

定义：关系中的每个属性都不可分。

<!--more-->

通俗讲就是数据表的每个表头都不可以继续细分，如：

![不符合第一范式的表结构][2]

就是不符合第一范式的典型。

第一范式是所有关系型数据库的最基本的要求，但是仅仅满足第一范式的话，会存在以下的问题：

 - 数据冗余： 每条数据可能有很多的属性都是重复的
 - 插入异常： 有可能某个属性为空值，待更新
 - 删除异常： 不可以删除特定属性的集合，不然会把所有的数据都删除
 - 修改异常

### 第二范式

第二范式在第一范式之上的改进：**2NF在1NF的基础上，消除了非主属性对于候选键的部分函数依赖**

首先需要阐释一下函数依赖的分类（分类详情可以去回答找）：

**完全函数依赖**： 

![完全函数依赖][3]

简单点说就是 x->y 的x的所有真子集X1 都没有 **X1->y**

**部分函数依赖**：

![部分函数依赖][4]

部分函数依赖我自己理解为完全函数依赖加上一些额外的属性。

**传递函数依赖**：

![传递函数依赖][5]

**候选键**：

![键][6]

我们老师把候选码称为候选键

**主属性**：

包含在任何一个候选键中的属性称为主属性。

回头看一下第二范式：

要判断一张表是否符合第二范式，判断的依据就是表中**是否存在非主属性对于键的部分函数依赖**，判断的方法：

第一步：找出数据表中所有的键。
第二步：根据第一步所得到的键，找出所有的主属性。
第三步：数据表中，除去所有的主属性，剩下的就都是非主属性了。
第四步：查看是否存在非主属性对键的部分函数依赖。

但是第二范式仍然会存在一些不足：

 - 删除异常
 - 插入异常

### 第三范式

第三范式在第二范式的基础上改进了：**消除了非主属性对于键的传递函数依赖** 。

也就是说，如果存在非主属性对于键的传递函数依赖，就是不符合第三范式。

### BCNF

有可能满足3NF仍然存在问题的数据表，BCNF解决的是**存在主属性对于键的部分函数依赖与传递依赖**的问题。

### 总结

关系型数据库的范式： 1NF,2NF,3NF,BCNF ..  （范式的要求递增，一般到BCNF就足够了）

- 1NF 的价值在于确保原子性，原子性的粒度，原子性的价值
- 2NF 检查了对键的完全依赖，控制数据冗余和查询性能
- 3NF 检查属性的独立性

## Mysql 外键

官方文档 [https://dev.mysql.com/doc/refman/5.7/en/constraint-foreign-key.html][7] 中对于外键约束的描述：

> Foreign keys let you cross-reference related data across tables, and foreign key constraints help keep this spread-out data consistent. 

外键可以让数据在不同的表之间互相参照从而实现参照完整性，而外键约束性则可以实现级联表间的数据一致性。

外键约束性一共四种方式：**RESTRICT(严格默认方式)**，**CASCADE(级联)**，**SET NULL(置空)**,**NO ACTION(不作为，被mysql当做RESTRICT处理)**，支持的动作有**ON UPDATE**以及**ON DELETE**。

外键约束性的定义：

![foreign key constraints][8]

mysql中会自动为外键列建立索引当外键列不存在索引时，来提高外键检索的效率，在定义之中可以指明索引的名字，也可以自行在sql中创建。

对于外键会有Parent Table 以及Child Table ，我的理解是Parent Table中的外键值和Child Table中的外键引用是一个一对多的关系，反之则是一对一的。

### 外键的约束性：

1，对子表的任何**INSERT**或者**UPDATE**的可能导致外键列改变为一个不在Parent Table之中存在的值，的更新操作都会失败。

2，对Parent Table的任何的**UPDATE**或者**DELETE**操作会根据定义的外键约束方式改变子表中外键列的值。

3，子表是不可能对Parent Table的外键列进行修改的

### 级联更新以及删除

**级联更新**

级联更新的例子：

``` sql
CREATE TABLE parent (
    id INT NOT NULL,
    PRIMARY KEY (id)
) ENGINE=INNODB;

CREATE TABLE child (
    id INT,
    parent_id INT,
    INDEX par_ind (parent_id),
    FOREIGN KEY (parent_id)
        REFERENCES parent(id)
        ON UPDATE CASCADE ON DELETE CASCADE
) ENGINE=INNODB;

INSERT INTO parent VALUES (1);
INSERT INTO parent VALUES (2);

INSERT INTO child VALUES (1,2);
INSERT INTO child VALUES (2,2);

UPDATE parent SET id=3 WHERE id=2;
```

直接看结果：

![enter description here][9]

子表中的外键会被同时更新为3.

**级联删除**

在外键更新之后执行`DELETE FROM parent WHERE id=3` ，可以看到子表中数据全部被级联删除：

![级联 delete][10]

### 外键约束性的 SET NULL 方式

>Delete or update the row from the parent table, and set the foreign key column or columns in the child table to NULL. Both ON DELETE SET NULL and ON UPDATE SET NULL clauses are supported. 

Parent Table中进行外键的更新或者删除之后，把关联的子表中的外键值置为NULL.

### NO ACTION / RESTRICT 方式

对Parent Table 中有关联子表的外键值的更新都会失败。



  [1]: https://www.zhihu.com/question/24696366
  [2]: http://ovn5va0pd.bkt.clouddn.com/%E5%B0%8F%E4%B9%A6%E5%8C%A0/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/1508228328378.jpg
  [3]: http://ovn5va0pd.bkt.clouddn.com/%E5%B0%8F%E4%B9%A6%E5%8C%A0/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/1508229246477.jpg
  [4]: http://ovn5va0pd.bkt.clouddn.com/%E5%B0%8F%E4%B9%A6%E5%8C%A0/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/1508229381046.jpg
  [5]: http://ovn5va0pd.bkt.clouddn.com/%E5%B0%8F%E4%B9%A6%E5%8C%A0/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/1508229535222.jpg
  [6]: http://ovn5va0pd.bkt.clouddn.com/%E5%B0%8F%E4%B9%A6%E5%8C%A0/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/1508229670029.jpg
  [7]: https://dev.mysql.com/doc/refman/5.7/en/constraint-foreign-key.html
  [8]: http://ovn5va0pd.bkt.clouddn.com/%E5%B0%8F%E4%B9%A6%E5%8C%A0/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/1508239025817.jpg
  [9]: http://ovn5va0pd.bkt.clouddn.com/%E5%B0%8F%E4%B9%A6%E5%8C%A0/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/1508242079328.jpg
  [10]: http://ovn5va0pd.bkt.clouddn.com/%E5%B0%8F%E4%B9%A6%E5%8C%A0/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/1508242258505.jpg